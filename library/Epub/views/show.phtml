<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="/reset.css" type="text/css" media="screen" />
		<link rel="stylesheet" href="/style.css" type="text/css" media="screen" />
		<script type="text/javascript">
			var toc = {};
			toc.toggle = function() {
				var el = document.getElementById("toc");
				if(el.className === 'opened') {
					el.scrollTop = 0;
					el.className = '';
				} else {
					el.className = 'opened';
				}
			};
			window.onresize = function(e) {
				var el = document.getElementById("toc");
				if(window.innerWidth < 600) { el.scrollTop = 0; }
			};
		</script>
	</head>
	<body>
		<div id="toc">
			<a id="toc-toggle" onclick="toc.toggle();"></a>
			<h2><?php echo $toc["title"]; ?></h2>
			<?php renderNavPoints($epub, $toc["navPoints"]); ?>
		</div>

		<iframe id="book" name="main" src="http://<?php echo $_SERVER['SERVER_NAME']; ?>/epub/serve/<?php echo $epub . "/" . $coverPage; ?>">
		</iframe>
		<a id="next-page" class="invisible">TODO: next page</a>
		<script type="text/javascript">
			var book = document.getElementById("book");
			function checkPosition() {
				var nextPage = document.getElementById("next-page");
				console.log(nextPage);
				console.log(book.contentWindow.scrollY + book.contentWindow.innerHeight, book.contentWindow.document.body.offsetHeight- 10);
				if(book.contentWindow.scrollY + book.contentWindow.innerHeight >= book.contentWindow.document.body.offsetHeight - 10) {
					nextPage.className = "visible";
				} else {
					nextPage.className = "invisible";
				}
			}
			book.onload = function() {
				book.contentWindow.onscroll = checkPosition;
				checkPosition();
			}
		</script>
	</body>
</html>

<?php function renderNavPoints($epub, $navPoints) { ?>
	<ul>
		<?php foreach($navPoints as $navPoint): ?>
			<li>
				<a onclick="if(window.innerWidth < 600) { toc.toggle(); }" target="main" href="http://<?php echo $_SERVER['SERVER_NAME']; ?>/epub/serve/<?php echo $epub . "/" . $navPoint["src"]; ?>">
					<?php echo $navPoint["label"]; ?>
					<?php if(isset($navPoint["navPoints"])) { renderNavPoints($epub, $navPoint["navPoints"]); } ?>
				</a>
			</li>
		<?php endforeach; ?>
	</ul>
<?php } ?>

